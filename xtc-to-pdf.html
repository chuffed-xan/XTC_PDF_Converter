<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>XTC → PDF Converter</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f5f5f5;
  padding: 20px;
  text-align: center;
}
button {
  padding: 8px 16px;
  font-size: 1rem;
}
progress {
  width: 320px;
  height: 18px;
}
</style>
</head>
<body>

<h3>XTC → PDF Converter</h3>

<input id="fileInput" type="file" accept=".xtc,.xtch"><br><br>
<button id="convertBtn" disabled>Convert to PDF</button>

<p id="status"></p>
<progress id="progress" value="0" max="100" hidden></progress>

<script src="./pdf-lib.min.js"></script>

<script>
/* =========
   XTC CODE
   (unchanged from your viewer, trimmed only where not needed)
========= */

const TEXT_DEC = new TextDecoder('utf-8');
const LE = true;
const MARK = { XTC: 0x00435458, XTCH: 0x48435458, XTG: 0x00475458, XTH: 0x00485458 };

class XTGH_Image {
  constructor(buf) {
    this.buf = buf;
    this.dv = new DataView(buf);
    this.parseHeader();
  }

  parseHeader() {
    const dv = this.dv;
    this.header = {
      mark: dv.getUint32(0,LE),
      width: dv.getUint16(4,LE),
      height: dv.getUint16(6,LE),
      colorMode: dv.getUint8(8),
      compression: dv.getUint8(9),
      dataSize: dv.getUint32(10,LE),
    };
  }

  getImageData() {
    const { width:w, height:h } = this.header;
    const raw = new Uint8Array(this.buf, 22);
    const rgba = new Uint8ClampedArray(w*h*4);

    if (this.header.mark === MARK.XTG) {
      const rowBytes = Math.ceil(w/8);
      for (let y=0;y<h;y++) {
        for (let x=0;x<w;x++) {
          const b = raw[y*rowBytes + (x>>3)];
          const bit = (b >> (7-(x&7))) & 1;
          const v = bit ? 255 : 0;
          const i = (y*w+x)*4;
          rgba[i]=rgba[i+1]=rgba[i+2]=v;
          rgba[i+3]=255;
        }
      }
    } else {
      const planeSize = Math.ceil((w*h)/8);
      const p1 = raw.subarray(0,planeSize);
      const p2 = raw.subarray(planeSize,planeSize*2);
      for (let x=0;x<w;x++) {
        const col=w-1-x;
        for (let y=0;y<h;y++) {
          const bi=(y>>3)+col*Math.ceil(h/8);
          const bit=y&7;
          const v=((p1[bi]>>(7-bit)&1)<<1)|(p2[bi]>>(7-bit)&1);
          const map=[255,85,170,0][v];
          const i=(y*w+x)*4;
          rgba[i]=rgba[i+1]=rgba[i+2]=map;
          rgba[i+3]=255;
        }
      }
    }
    return {width:w,height:h,imageData:rgba};
  }
}

class XTC_File {
  constructor(buf){
    this.buf=buf;
    this.dv=new DataView(buf);
    this.parseHeader();
    this.parseIndex();
  }
  parseHeader(){
    const dv=this.dv;
    this.pageCount=dv.getUint16(6,LE);
    this.indexOffset=Number(dv.getBigUint64(24,LE));
  }
  parseIndex(){
    this.index=[];
    let off=this.indexOffset;
    for(let i=0;i<this.pageCount;i++){
      this.index.push({
        offset:Number(this.dv.getBigUint64(off,LE)),
        size:this.dv.getUint32(off+8,LE),
      });
      off+=16;
    }
  }
  getPage(i){
    const e=this.index[i];
    return new XTGH_Image(this.buf.slice(e.offset,e.offset+e.size));
  }
}

/* =========
   PDF LOGIC
========= */

const { PDFDocument } = PDFLib;

const input = document.getElementById("fileInput");
const btn = document.getElementById("convertBtn");
const status = document.getElementById("status");
const prog = document.getElementById("progress");

let xtc=null;
let filename="";

input.onchange = async e => {
  const f=e.target.files[0];
  if(!f) return;
  filename=f.name.replace(/\.(xtc|xtch)$/i,'');
  xtc=new XTC_File(await f.arrayBuffer());
  btn.disabled=false;
  status.textContent=`Loaded ${xtc.pageCount} pages`;
};

btn.onclick = async () => {
  btn.disabled=true;
  prog.hidden=false;
  prog.max=xtc.pageCount;
  const pdf = await PDFDocument.create();

  for(let i=0;i<xtc.pageCount;i++){
    status.textContent=`Converting page ${i+1}/${xtc.pageCount}`;
    prog.value=i+1;

    const img=xtc.getPage(i).getImageData();
    const canvas=document.createElement("canvas");
    canvas.width=img.width;
    canvas.height=img.height;
    canvas.getContext("2d").putImageData(
      new ImageData(img.imageData,img.width,img.height),0,0
    );

    const png = await pdf.embedPng(canvas.toDataURL("image/png"));
    const page = pdf.addPage([img.width,img.height]);
    page.drawImage(png,{x:0,y:0,width:img.width,height:img.height});

    await new Promise(r=>setTimeout(r,0)); // yield
  }

  const blob = new Blob([await pdf.save()],{type:"application/pdf"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename+".pdf";
  a.click();

  status.textContent="Done";
  prog.hidden=true;
};
</script>

</body>
</html>
